{"version":3,"file":"index.spec.js","sourceRoot":"","sources":["../src/index.spec.ts"],"names":[],"mappings":"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","sourcesContent":["import { compose, Next, Middleware } from './index'\nimport { expect } from 'chai'\n\ndescribe('compose middleware', () => {\n  it('should be assignable to array of middleware', (done) => {\n    const pipeline = <T, U> (...middlewares: Array<Middleware<T, U>>) => compose(middlewares)\n    const middleware = pipeline((req: undefined, res: undefined, next: () => void) => next())\n\n    return middleware(undefined, undefined, done)\n  })\n\n  it('should compose middleware', (done) => {\n    const middleware = compose([\n      function (req: any, res: any, next: Next) {\n        req.one = true\n        next()\n      },\n      function (req: any, res: any, next: Next) {\n        req.two = true\n        next()\n      }\n    ])\n\n    const req: any = {}\n    const res: any = {}\n\n    middleware(req, res, function (err) {\n      expect(err).to.equal(undefined)\n      expect(req.one).to.equal(true)\n      expect(req.two).to.equal(true)\n\n      return done()\n    })\n  })\n\n  it('should exit with an error', (done) => {\n    const middleware = compose([\n      function (req: any, res: any, next: Next) {\n        req.one = true\n        next(new Error('test'))\n      },\n      function (req: any, res: any, next: Next) {\n        req.two = true\n        next()\n      }\n    ])\n\n    const req: any = {}\n    const res: any = {}\n\n    middleware(req, res, function (err) {\n      expect(err).instanceOf(Error)\n      expect(req.one).to.equal(true)\n      expect(req.two).to.equal(undefined)\n\n      return done()\n    })\n  })\n\n  it('should short-cut handler with a single function', (done) => {\n    const middleware = compose([\n      function (req: any, res: any, next: Next) {\n        req.one = true\n        next()\n      }\n    ])\n\n    const req: any = {}\n    const res: any = {}\n\n    middleware(req, res, function (err) {\n      expect(err).to.equal(undefined)\n      expect(req.one).to.equal(true)\n\n      return done()\n    })\n  })\n\n  it('should accept a single function', (done) => {\n    const middleware = compose<any, any>(function (req: any, res: any, next: Next) {\n      req.one = true\n      next()\n    })\n\n    const req: any = {}\n\n    middleware(req, {}, function (err?: Error | null) {\n      expect(err).to.equal(undefined)\n      expect(req.one).to.equal(true)\n\n      return done()\n    })\n  })\n\n  it('should noop with no middleware', (done) => {\n    const middleware = compose([])\n\n    middleware({}, {}, done)\n  })\n\n  it('should validate all handlers are functions', () => {\n    expect(() => compose(['foo'] as any)).to.throw(TypeError, 'Handlers must be a function')\n  })\n\n  it('should support error handlers', (done) => {\n    const middleware = compose(\n      function (req: any, res: any, next: Next) {\n        return next(new Error('test'))\n      },\n      function (_: Error, req: any, res: any, next: Next) {\n        return next()\n      },\n      function (req: any, res: any, next: Next) {\n        req.success = true\n        return next()\n      },\n      function (_: Error, req: any, res: any, next: Next) {\n        req.fail = true\n        return next()\n      }\n    )\n\n    const req: any = {}\n\n    middleware(req, {} as any, function (err) {\n      expect(req.fail).to.equal(undefined)\n      expect(req.success).to.equal(true)\n\n      return done(err)\n    })\n  })\n\n  it('should error when calling `next()` multiple times', (done) => {\n    const middleware = compose<any, any>(\n      function (req: any, res: any, next: Next) {\n        next()\n        next()\n      }\n    )\n\n    try {\n      middleware({}, {}, function () {/* */})\n    } catch (err) {\n      expect(err.message).to.equal('`next()` called multiple times')\n\n      return done()\n    }\n  })\n\n  it('should forward thrown errors', (done) => {\n    const middleware = compose<any, any>(\n      function (req: any, res: any, next: Next) {\n        throw new Error('Boom!')\n      }\n    )\n\n    middleware({}, {}, function (err) {\n      expect(err).instanceOf(Error)\n      expect(err!.message).to.equal('Boom!')\n\n      return done()\n    })\n  })\n\n  it('should not cascade errors from `done()`', (done) => {\n    const request = {\n      done: 0,\n      first: 0,\n      second: 0,\n      third: 0\n    }\n\n    const middleware = compose<typeof request, any>(\n      function (req: typeof request, res: any, next: Next) {\n        req.first++\n\n        return next()\n      },\n      function (req: typeof request, res: any, next: Next) {\n        req.second++\n\n        throw new TypeError('Boom!')\n      },\n      function (req: typeof request, res: any, next: Next) {\n        req.third++\n\n        return next()\n      }\n    )\n\n    try {\n      middleware(request, {}, function () {\n        request.done++\n\n        throw new TypeError('This is the end')\n      })\n    } catch (err) {\n      expect(request.done).to.equal(1)\n      expect(request.first).to.equal(1)\n      expect(request.second).to.equal(1)\n      expect(request.third).to.equal(0)\n\n      expect(err).instanceOf(TypeError)\n      expect(err.message).to.equal('This is the end')\n\n      return done()\n    }\n\n    return done(new TypeError('Missed thrown error'))\n  })\n\n  it('should avoid handling post-next thrown errors', function (done) {\n    const middleware = compose<any, any>(\n      function (req: any, res: any, next: Next) {\n        return next()\n      },\n      function (req: any, res: any, next: Next) {\n        next()\n        throw new TypeError('Boom!')\n      },\n      function (req: any, res: any, next: Next) {\n        return setTimeout(next)\n      }\n    )\n\n    try {\n      middleware({}, {}, function (err) {\n        return done(err)\n      })\n    } catch (err) {\n      expect(err).instanceOf(TypeError)\n      expect(err.message).to.equal('Boom!')\n      return\n    }\n\n    return done(new TypeError('Missed thrown error'))\n  })\n\n  it('should compose functions without all arguments', function (done) {\n    const middleware = compose<any, any>(\n      function (req: any, res: any, next: Next) {\n        return next()\n      },\n      function () {\n        return done()\n      }\n    )\n\n    middleware({}, {}, function (err) {\n      return done(err || new Error('Middleware should not have finished'))\n    })\n  })\n})\n"]}